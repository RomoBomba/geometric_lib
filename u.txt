#!/bin/bash
# backup.sh

set -euo pipefail

SRC_DIR="/home/user/source"
BACKUP_ROOT="/home/user"
REPORT_FILE="/home/user/backup-report"
TODAY=$(date +%F)

mkdir -p "$SRC_DIR"
touch "$REPORT_FILE"

# Найти самый свежий backup каталог
latest_backup=$(find "$BACKUP_ROOT" -maxdepth 1 -type d -name 'Backup-*' | sort -r | head -n 1)

if [ -n "$latest_backup" ]; then
    backup_date=$(basename "$latest_backup" | cut -d- -f2-)
    seconds_diff=$(( $(date +%s) - $(date -d "$backup_date" +%s) ))
else
    seconds_diff=$((8 * 86400))
    backup_date="1970-01-01"
fi

if [ "$seconds_diff" -ge $((7 * 86400)) ]; then
    # Создание нового бэкапа
    new_backup="$BACKUP_ROOT/Backup-$TODAY"
    mkdir "$new_backup"
    echo "[$TODAY] new backup folder created: Backup-$TODAY" >> "$REPORT_FILE"

    for file in "$SRC_DIR"/*; do
        [ -f "$file" ] || continue
        cp "$file" "$new_backup"
        echo "$(basename "$file")" >> "$REPORT_FILE"
    done
else
    # Обновление существующего бэкапа
    echo "[$TODAY] updating backup folder: Backup-$backup_date" >> "$REPORT_FILE"
    new_backup="$BACKUP_ROOT/Backup-$backup_date"
    new_files=""
    updated_files=""

    for file in "$SRC_DIR"/*; do
        [ -f "$file" ] || continue
        base="$(basename "$file")"
        target="$new_backup/$base"

        if [ ! -f "$target" ]; then
            cp "$file" "$target"
            new_files+="$base\n"
        else
            orig_size=$(stat -c %s "$target")
            new_size=$(stat -c %s "$file")
            if [ "$orig_size" -ne "$new_size" ]; then
                mv "$target" "$target.$TODAY"
                cp "$file" "$target"
                updated_files+="$base $base.$TODAY\n"
            fi
        fi
    done

    echo -e "$new_files$updated_files" >> "$REPORT_FILE"
fi
