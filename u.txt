#!/bin/bash

set -euo pipefail

file_name="$1"

if [ -z "$file_name" ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

if [ ! -f "$HOME/.trash.log" ]; then
    echo "Trash log not found."
    exit 1
fi

found=false

while IFS= read -r line || [ -n "$line" ]; do 
    trash_name="${line##* }"
    file_path="${line% $trash_name}"
    cur_file_name="$(basename "$file_path")"
    dir="$(dirname "$file_path")"

    if [ "$cur_file_name" != "$file_name" ]; then
        continue
    fi

    found=true
    echo "Found: $file_path"
    while true; do
        read -r -p "Do you want to restore $file_path? [y/N] " response
        case "$response" in
            [yY][eE][sS]|[yY])
                if [ ! -d "$dir" ]; then
                    echo "Directory $dir not found. Restoring to home directory."
                    dir="$HOME"
                fi

                target="$dir/$cur_file_name"
                if [ -f "$target" ]; then
                    echo "File '$target' already exists."
                    while true; do
                        read -r -p "Please enter a new name: " new_name
                        target="$dir/$new_name"
                        if [ ! -e "$target" ]; then
                            break
                        fi
                        echo "File '$target' also exists."
                    done
                fi

                if [ ! -f "$HOME/.trash/$trash_name" ]; then
                    echo "Error: trash file '$trash_name' not found."
                    break
                fi

                if ln "$HOME/.trash/$trash_name" "$target" 2>/dev/null || cp "$HOME/.trash/$trash_name" "$target"; then
                    rm "$HOME/.trash/$trash_name"
                    sed -i "\|$file_path $trash_name\$|d" "$HOME/.trash.log"
                    echo "File restored to '$target'"
                else
                    echo "Error: failed to restore file."
                fi
                break
                ;;
            [nN][oO]|[nN])
                echo "Skipping..."
                break
                ;;
            *)
                echo "Please answer yes or no (y/n)."
                ;;
        esac
    done
done < "$HOME/.trash.log"

if ! $found; then
    echo "No entries found for filename '$file_name'."
fi
