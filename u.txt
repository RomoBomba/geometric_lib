#!/bin/bash

set -euo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

filename="$1"

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TRASH_DIR="$SCRIPT_DIR/trash"
LOG_FILE="$SCRIPT_DIR/trash.log"

if [ ! -f "$LOG_FILE" ]; then
    echo "No trash log found."
    exit 0
fi

found=false

while IFS= read -r line || [ -n "$line" ]; do
    file_path="${line% *}"
    trash_name="${line##* }"
    base_name="$(basename "$file_path")"

    if [ "$base_name" != "$filename" ]; then
        continue
    fi

    found=true
    echo "Found: $file_path"
    echo -n "Restore this file? [y/N] " > /dev/tty
    read -r response < /dev/tty

    case "$response" in
        [yY][eE][sS]|[yY])
            dir_path=$(dirname "$file_path")
            target_path="$file_path"

            # если оригинальная директория не существует — восстанавливаем в текущую
            if [ ! -d "$dir_path" ]; then
                echo "Original directory missing. Restoring to current directory."
                target_path="./$base_name"
            fi

            # если файл уже существует — спросим новое имя
            if [ -e "$target_path" ]; then
                echo "File '$target_path' already exists."
                while true; do
                    echo -n "Enter new name: " > /dev/tty
                    read -r new_name < /dev/tty
                    target_path="$(dirname "$target_path")/$new_name"
                    if [ ! -e "$target_path" ]; then
                        break
                    fi
                    echo "That file also exists." > /dev/tty
                done
            fi

            if [ -e "$TRASH_DIR/$trash_name" ]; then
                mv "$TRASH_DIR/$trash_name" "$target_path"
                sed -i "\|$file_path $trash_name\$|d" "$LOG_FILE"
                echo "File restored to: $target_path"
            else
                echo "Trash file '$trash_name' not found."
            fi
            ;;
        * )
            echo "Skipping..."
            ;;
    esac
done < "$LOG_FILE"

if ! $found; then
    echo "No entries found for filename '$filename'."
fi
