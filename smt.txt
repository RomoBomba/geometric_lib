#!/bin/bash

set -euo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

file="$1"
file_path="$(realpath -- "$file" 2>/dev/null || true)"

if [ ! -f "$file_path" ]; then
    echo "Error: '$file' is not a valid file."
    exit 1
fi

mkdir -p "$HOME/.trash"
touch "$HOME/.trash.log"

n=1
while [ -e "$HOME/.trash/$n" ]; do
    ((n++))
done

# Сначала пробуем создать жёсткую ссылку
if ln "$file_path" "$HOME/.trash/$n" 2>/dev/null; then
    echo "$file_path $n" >> "$HOME/.trash.log"
    rm "$file_path"
    echo "Moved '$file_path' to ~/.trash as '$n'"
else
    echo "Warning: Hard link failed (maybe different FS). Trying copy..."
    if cp "$file_path" "$HOME/.trash/$n"; then
        echo "$file_path $n" >> "$HOME/.trash.log"
        rm "$file_path"
        echo "Copied and removed '$file_path' as trash/$n"
    else
        echo "Error: Cannot move file '$file_path' to trash."
        exit 2
    fi
fi
