#!/bin/bash

set -euo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

filename="$1"

if [ ! -f "$HOME/.trash.log" ]; then
    echo "No trash log found."
    exit 0
fi

grep -a -- " $(printf '%q' "$filename")\$" "$HOME/.trash.log" | while read -r line; do
    filepath="${line% *}"
    linkname="${line##* }"
    dirpath=$(dirname "$filepath")
    base=$(basename "$filepath")

    echo "Found: $filepath"
    read -rp "Restore this file? [y/N] " answer
    case "$answer" in
        [yY]* )
            if [ ! -e "$HOME/.trash/$linkname" ]; then
                echo "Warning: Trash file '$linkname' not found."
                continue
            fi

            if [ ! -d "$dirpath" ]; then
                echo "Directory '$dirpath' does not exist. Restoring to home directory."
                dirpath="$HOME"
            fi

            target="$dirpath/$base"
            if [ -e "$target" ]; then
                echo "File '$target' already exists."
                while true; do
                    read -rp "Enter new name: " newname
                    target="$dirpath/$newname"
                    if [ ! -e "$target" ]; then
                        break
                    fi
                done
            fi

            if ln "$HOME/.trash/$linkname" "$target"; then
                rm "$HOME/.trash/$linkname"
                sed -i "\|$filepath $linkname\$|d" "$HOME/.trash.log"
                echo "File restored to $target"
            else
                echo "Error: Failed to restore file."
            fi
            ;;
        * ) ;;
    esac
done
