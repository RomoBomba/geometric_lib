#!/bin/bash

set -euo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

filename="$1"
filepath="$(realpath -- "$filename" 2>/dev/null || true)"

if [ ! -f "$filepath" ]; then
    echo "Error: File '$filename' not found."
    exit 2
fi

# Используем текущую директорию
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
TRASH_DIR="$SCRIPT_DIR/trash"
LOG_FILE="$SCRIPT_DIR/trash.log"

mkdir -p "$TRASH_DIR"
touch "$LOG_FILE"

# Найти свободное имя
n=1
while [ -e "$TRASH_DIR/$n" ]; do
    ((n++))
done

if ln "$filepath" "$TRASH_DIR/$n" 2>/dev/null; then
    echo "$filepath $n" >> "$LOG_FILE"
    rm "$filepath"
    echo "Moved '$filepath' to trash as '$n'"
else
    echo "Hard link failed (maybe different FS), trying copy..."
    if cp "$filepath" "$TRASH_DIR/$n"; then
        echo "$filepath $n" >> "$LOG_FILE"
        rm "$filepath"
        echo "Copied and removed '$filepath' as trash/$n"
    else
        echo "Error: Could not move file"
        exit 3
    fi
fi
