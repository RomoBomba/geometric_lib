#!/bin/bash

set -euo pipefail

if [ $# -ne 1 ]; then
    echo "Usage: $0 <filename>"
    exit 1
fi

filename="$1"
filepath="$(realpath -- "$filename" 2>/dev/null || true)"

if [ ! -f "$filepath" ]; then
    echo "Error: File '$filename' not found or is not a regular file."
    exit 2
fi

mkdir -p "$HOME/.trash"
touch "$HOME/.trash.log"

linkname=1
while [ -e "$HOME/.trash/$linkname" ]; do
    ((linkname++))
done

if ln -- "$filepath" "$HOME/.trash/$linkname"; then
    echo "$filepath $linkname" >> "$HOME/.trash.log"
    rm -- "$filepath"
    echo "Moved '$filepath' to trash as '$linkname'"
else
    echo "Error: Could not create hard link. Are you on different filesystems?"
    exit 3
fi
